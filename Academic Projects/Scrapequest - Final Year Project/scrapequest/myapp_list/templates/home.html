{% extends 'base.html' %}

{% block content %}
{% load static %}

<!-- Load Tailwind CSS for styling -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
<!-- Load Chart.js for charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% load home_filter %}

<div class="container mx-auto p-6">

    <!-- Welcome Message -->
    <div class="mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">Welcome back, {{ user.username }}!</h2>
    </div>

    <!-- Stats Cards and Organization Doughnut Chart -->
    <div class="flex flex-wrap justify-between mb-6">
        <!-- Stats Cards -->
        <div class="w-full lg:w-2/3 flex flex-wrap justify-between">
            {% for org, count in project_counts.items %}
            <div class="bg-white p-5 rounded-lg shadow-md flex items-center justify-between mb-4 mr-4 w-full sm:w-5/12">
                <div>
                    <div class="text-sm font-medium text-gray-500">{{ org }}</div>
                    <div class="text-3xl font-bold text-gray-800">{{ count }}</div>
                </div>
                <div class="text-2xl">
                    <!-- Colored square for organization -->
                    <span class="inline-block w-8 h-8" style="background-color: {{ org|color_for_organization }}"></span>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Doughnut Chart for Organization -->
        <div class="w-full lg:w-1/3">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Number of Projects by Organization</h3>
                <canvas id="orgDoughnutChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Bar Chart for Keyword -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Number of Projects by Keyword</h3>
        <canvas id="keywordBarChart"></canvas>
    </div>

    <!-- Another Chart for Yearly Distribution -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Yearly Distribution of Projects</h3>
        <canvas id="yearlyDistributionChart"></canvas>
    </div>

    <!-- Retrieve the data for charts -->
    {{ project_counts|json_script:"projectCountsData" }}
    {{ keyword_counts|json_script:"keywordCountsData" }}
    {{ yearly_counts|json_script:"yearlyCountsData" }}
</div>

<script>
// Retrieve the data from the JSON script tag and parse it
const projectCounts = JSON.parse(document.getElementById('projectCountsData').textContent);
const keywordCounts = JSON.parse(document.getElementById('keywordCountsData').textContent);
const yearlyCounts = JSON.parse(document.getElementById('yearlyCountsData').textContent);

// Colors for the organization chart
const orgColors = Object.keys(projectCounts).map(org => getRandomColor()); // Function to generate random colors

// Doughnut Chart for Organization
const orgDoughnutChart = new Chart(document.getElementById('orgDoughnutChart'), {
    type: 'doughnut',
    data: {
        labels: Object.keys(projectCounts),
        datasets: [{
            data: Object.values(projectCounts),
            backgroundColor: orgColors,
        }]
    },
    options: {
        animation: {
            animateScale: true
        }
    }
});

// Bar Chart for Keywords
const keywordBarChart = new Chart(document.getElementById('keywordBarChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(keywordCounts),
        datasets: [{
            label: 'Number of Projects',
            data: Object.values(keywordCounts),
            backgroundColor: funColors(keywordCounts.length), // Function to generate an array of fun colors
        }]
    },
    options: {
        animation: {
            duration: 2000,
            easing: 'easeOutElastic',
        },
        scales: {
            yAxes: [{
                ticks: {
                    beginAtZero: true
                }
            }]
        }
    }
});

// Yearly Distribution Chart - Polar Area
const yearlyDistributionChart = new Chart(document.getElementById('yearlyDistributionChart'), {
    type: 'polarArea',
    data: {
        labels: Object.keys(yearlyCounts),
        datasets: [{
            label: 'Number of Projects',
            data: Object.values(yearlyCounts),
            backgroundColor: funColors(Object.keys(yearlyCounts).length),
        }]
    },
    options: {
        animation: {
            animateRotate: true
        }
    }
});

// Functions to generate colors
function getRandomColor() {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}

function funColors(count) {
    const colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(getRandomColor());
    }
    return colors;
}

</script>

{% endblock %}
